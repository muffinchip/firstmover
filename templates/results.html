{% extends "layout.html" %}
{% block title %}Your FirstMover Results{% endblock %}
{% block body %}
<style>
  .fm-wrap{max-width:900px;margin:0 auto;padding:24px}
  .headline{font-size:24px;font-weight:700;margin-bottom:8px}
  .subnote{color:#555;margin-bottom:14px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:13px;font-weight:600}
  .badge.ok{background:#e8f5e9;color:#1b5e20}
  .badge.na{background:#f6f7f9;color:#555}
  .cards{display:flex;flex-direction:column;gap:14px;margin-top:18px}
  .card{background:#fff;border:1px solid #e7e7e7;border-radius:12px;padding:16px}
  .card h3{margin:0 0 8px 0;font-size:18px;display:flex;align-items:center;gap:8px}
  .meta{font-size:13px;color:#666;margin-top:4px}
  .narr{margin-top:6px}
  .chartBox{margin:10px 0}
  .chartBox canvas{width:100%;height:280px}
  .logos{height:20px;margin-top:4px}
  .pill{position:absolute;transform:translate(-50%,-8px);padding:2px 8px;border-radius:999px;background:#111;color:#fff;font-size:12px;font-weight:700;white-space:nowrap}
  .barWrap{position:relative;margin-top:6px}
  .sectionTitle{margin-top:28px;font-weight:700}
</style>

<div class="fm-wrap">
  {% set composite_text = (score ~ '%') if score is not none else 'N/A' %}
  {% set v_text = (score_verified ~ '%') if score_verified is not none else 'N/A' %}

  <div class="headline">You average in the top {{ composite_text }} of early adopters</div>
  <div class="subnote">
    Verified composite: 
    {% if score_verified is not none %}
      <span class="badge ok">✔︎ {{ score_verified }}%</span>
    {% else %}
      <span class="badge na">N/A</span>
    {% endif %}
  </div>

  <div class="cards">
    {% for p in platforms %}
      <div class="card">
        <h3>
          {% if p.logo_url %}<img src="{{ p.logo_url }}" alt="" class="logos" onerror="this.style.display='none'">{% endif %}
          {{ p.name }}
          {% if p.verified %}<span class="badge ok">✔︎ verified</span>{% endif %}
        </h3>

        <div class="narr">
          You joined {{ p.name }} {{ p.narrative_after }} after launch, before {{ p.narrative_percent }}% of current users.
          When you joined {{ p.name }}, it had approximately {{ '{:,}'.format(p.joined_users) }} users compared to {{ '{:,}'.format(p.today_users) }} today.
        </div>
        <div class="meta">
          Joined: {{ p.joined }}{% if p.email_hint %} &nbsp;·&nbsp; <em>{{ p.email_hint }}</em>{% endif %}
        </div>

        <div class="chartBox">
          <canvas id="line_{{ loop.index }}"></canvas>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="sectionTitle" style="margin-top:30px;">
    You average in the top {{ composite_text }} of early adopters
  </div>
  <div class="subnote">
    Verified composite: 
    {% if score_verified is not none %}
      <span class="badge ok">✔︎ {{ score_verified }}%</span>
    {% else %}
      <span class="badge na">N/A</span>
    {% endif %}
  </div>
  <div class="subnote">Lower percentile = earlier adoption. ✔︎ indicates verified by email.</div>

  <div class="barWrap">
    <canvas id="bars"></canvas>
    <div id="pills-layer"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script>
const labels = {{ (chart_labels | default(platforms | map(attribute='name') | list)) | tojson }};
const values = {{ (chart_values | default(platforms | map(attribute='percentile') | list)) | tojson }};
const verifiedFlags = {{ (chart_verified | default(platforms | map(attribute='verified') | list)) | tojson }};

const LOGOS = {
  "Gmail":"https://upload.wikimedia.org/wikipedia/commons/4/4e/Gmail_Icon.png",
  "Facebook":"https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png",
  "Twitter/X":"https://upload.wikimedia.org/wikipedia/commons/5/53/X_logo_2023_original.svg",
  "Instagram":"https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png",
  "LinkedIn":"https://upload.wikimedia.org/wikipedia/commons/8/81/LinkedIn_icon.svg",
  "Dropbox":"https://upload.wikimedia.org/wikipedia/commons/7/78/Dropbox_Icon.svg",
  "OpenAI/ChatGPT":"https://upload.wikimedia.org/wikipedia/commons/4/4d/OpenAI_Logo.svg",
  "Spotify":"https://upload.wikimedia.org/wikipedia/commons/1/19/Spotify_logo_without_text.svg",
  "Reddit":"https://upload.wikimedia.org/wikipedia/commons/5/58/Reddit_logo_new.svg",
  "Amazon Prime":"https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg"
};

const scoreVerified = {{ (score_verified if score_verified is not none else 'null')|tojson }};

const ctx = document.getElementById('bars').getContext('2d');
const pillsLayer = document.getElementById('pills-layer');

function clearPills(){ pillsLayer.innerHTML = ''; }
function makePill(text, x, y, verified){
  const d = document.createElement('div');
  d.className = 'pill';
  d.style.left = x+'px';
  d.style.top = y+'px';
  d.style.background = verified ? '#111' : '#333';
  d.style.color = '#fff';
  d.textContent = text;
  pillsLayer.appendChild(d);
  return d;
}

const drawImagesPlugin = {
  id: 'drawImages',
  afterDatasetsDraw(chart){
    const {ctx, chartArea:{bottom}, scales:{x}} = chart;
    const y = bottom + 18;
    x.ticks.forEach((t, i) => {
      const label = labels[i];
      const imgSrc = LOGOS[label];
      if(!imgSrc) return;
      const xPos = x.getPixelForTick(i);
      const img = new Image();
      img.onload = () => {
        const w = 20, h = 20;
        ctx.save();
        ctx.drawImage(img, xPos - w/2, y, w, h);
        ctx.restore();
      };
      img.src = imgSrc;
    });
  }
};

const dashedLinePlugin = {
  id: 'verifiedLine',
  afterDatasetsDraw(chart){
    if(scoreVerified == null) return;
    const {ctx, chartArea, scales:{y}} = chart;
    const yPix = y.getPixelForValue(scoreVerified);
    ctx.save();
    ctx.setLineDash([6,4]);
    ctx.lineWidth = 1.5;
    ctx.strokeStyle = '#999';
    ctx.beginPath();
    ctx.moveTo(chartArea.left, yPix);
    ctx.lineTo(chartArea.right, yPix);
    ctx.stroke();
    ctx.restore();

    // Recreate pills on top
    clearPills();
    const meta = chart.getDatasetMeta(0);
    meta.data.forEach((bar, i) => {
      const x = bar.x;
      const topY = Math.min(bar.y, chartArea.bottom-4) - 10;
      const text = (values[i] != null) ? `${values[i]}%${verifiedFlags[i] ? ' ✔︎' : ''}` : 'N/A';
      makePill(text, x, topY, verifiedFlags[i]);
    });
  }
};

const barChart = new Chart(ctx, {
  type:'bar',
  data:{
    labels: labels,
    datasets:[{
      data: values,
      borderWidth: 0,
      backgroundColor: labels.map((_,i)=> verifiedFlags[i] ? 'rgba(31,110,235,0.85)' : 'rgba(31,110,235,0.35)'),
    }]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{ legend:{display:false}, tooltip:{enabled:true} },
    scales:{
      y:{ title:{display:true,text:'Percentile (lower = earlier)'}, min:0,max:100, grid:{color:'#eee'} },
      x:{ ticks:{color:'#222'} }
    },
    animation:false
  },
  plugins:[drawImagesPlugin, dashedLinePlugin]
});

// Mini line charts
const platformPayload = {{ platforms|tojson }};
function renderLine(idx, points, joinISO){
  const canvas = document.getElementById(`line_${idx}`);
  if(!canvas || !points || !points.length) return;

  const labels = points.map(p=>p.x);
  const values = points.map(p=>p.y);

  const c = new Chart(canvas.getContext('2d'), {
    type:'line',
    data:{ labels, datasets:[{ data: values, pointRadius:0, fill:false, tension:0 }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{display:false}, tooltip:{enabled:true}},
      scales:{
        x:{ grid:{display:false}, ticks:{ callback: (v, i)=> (labels[i]||'').slice(0,4) } },
        y:{ title:{display:true,text:'Users (Millions)'}, grid:{color:'#f0f0f0'} }
      },
      animation:false
    },
    plugins: [{
      id:'joinDash',
      afterDatasetsDraw(chart){
        const {ctx, chartArea:{top,bottom}, scales:{x}} = chart;
        let jIndex = labels.indexOf(joinISO);
        if(jIndex < 0){
          const jy = (joinISO||'').slice(0,4);
          jIndex = labels.findIndex(d => d.slice(0,4)===jy);
        }
        if(jIndex < 0) return;
        const xPix = x.getPixelForValue(jIndex);
        ctx.save();
        ctx.setLineDash([6,4]);
        ctx.strokeStyle = '#999';
        ctx.beginPath();
        ctx.moveTo(xPix, top);
        ctx.lineTo(xPix, bottom);
        ctx.stroke();
        ctx.restore();
      }
    }]
  });
}
platformPayload.forEach((p, idx)=>{
  const points = (p.chart && p.chart.points_m) ? p.chart.points_m : [];
  renderLine(idx+1, points, p.join_iso);
});
</script>
{% endblock %}
