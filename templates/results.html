{% extends "layout.html" %}
{% block body %}
  <div class="card">
    <a href="{{ url_for('index') }}" class="btn secondary">← Start over</a>
    <h2>Your Early Adopter Results</h2>
    {% if not platforms or not platforms|selectattr("name","equalto","Gmail")|selectattr("percentile")|list %}
      <p class="note">Missing Gmail date? <a href="{{ url_for('login_google') }}">Grant Gmail access</a>.</p>
    {% endif %}
    {% if score is not none %}
      <p style="font-size:22px; font-weight:700;">Composite Percentile (users-based): {{ score }}/100</p>
      <p class="note">This is the percent of current users who arrived after you, averaged across connected platforms.</p>
    {% else %}
      <p class="note">Add at least one platform to compute your users-based percentile.</p>
    {% endif %}

    <div class="row">
      <div class="col">
        <h3>Platforms</h3>
        {% for p in platforms %}
          <div class="platform">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><strong>{{ p.name }}</strong></div>
              {% if p.percentile is not none %}<span class="pill">{{ p.percentile }}th percentile</span>{% endif %}
            </div>
            <div class="note">Joined: {{ p.joined }} {% if p.username %}( {{ p.username }} ){% endif %}</div>

            {% if p.joined_users and p.today_users %}
              <p style="margin:6px 0 0 0;">
                You joined {{ p.name }} before <strong>{{ p.narrative_percent }}%</strong> of current users.
                When you joined, {{ p.name }} had approximately <strong>{{ "{:,}".format(p.joined_users) }}</strong>
                users compared to <strong>{{ "{:,}".format(p.today_users) }}</strong> today —
                {{ p.narrative_fact }}.
              </p>
            {% endif %}

            {% if p.chart %}
              <div style="margin-top:10px;">
                <canvas id="curve-{{ loop.index }}"></canvas>
              </div>
              <script>
                (function(){
                  const labels = {{ p.chart['labels']|tojson }};      // ["2004","2005",...]
                  const valuesM = {{ p.chart['values_m']|tojson }};    // users in millions
                  const ctx = document.getElementById('curve-{{ loop.index }}').getContext('2d');

                  const datasets = [{
                    type: 'line',
                    label: 'Cumulative users (Millions)',
                    data: valuesM,
                    fill: false,
                    tension: 0.1
                  }];

                  {% if p.join_label %}
                    const joinLabel = "{{ p.join_label }}";            // e.g. "2010"
                    const idx = labels.indexOf(joinLabel);
                    if (idx >= 0) {
                      const top = Math.max.apply(null, valuesM) * 1.05;
                      const base = 0;
                      const vDataTop = new Array(valuesM.length).fill(null); vDataTop[idx] = top;
                      const vDataBase = new Array(valuesM.length).fill(null); vDataBase[idx] = base;
                      datasets.push({ type: 'line', data: vDataTop, borderDash: [6,4], pointRadius: 0 });
                      datasets.push({ type: 'line', data: vDataBase, borderDash: [6,4], pointRadius: 0 });
                    }
                  {% endif %}

                  new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: datasets },
                    options: {
                      plugins: { legend: { display: false } },
                      scales: {
                        x: {
                          ticks: { maxRotation: 0, autoSkip: true },
                          title: { display: true, text: 'Year' }
                        },
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Users (Millions)' }
                        }
                      }
                    }
                  });
                })();
              </script>
            {% endif %}

            {% if p.note %}<div class="note">Note: {{ p.note }}</div>{% endif %}
          </div>
        {% endfor %}
      </div>

      <div class="col">
        <h3>Your place on the curve</h3>
        <canvas id="curveChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Bar chart for users-based percentiles
    const labels = {{ platforms|map(attribute='name')|list|tojson }};
    const data = {{ platforms|map(attribute='percentile')|list|tojson }}.map(v => v === null ? 0 : v);
    const ctx = document.getElementById('curveChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Users-based Percentile (0–100)',
          data: data
        }]
      },
      options: {
        scales: {
          y: { beginAtZero: true, max: 100, title: { display: true, text: 'Percentile' } },
          x: { title: { display: true, text: 'Platform' } }
        },
        plugins: { legend: { display: false } }
      }
    });
  </script>
{% endblock %}
